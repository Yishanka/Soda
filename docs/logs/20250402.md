# **SODA é€Ÿæ­ æ•°æ®åº“å…³ç³»æŠ¥å‘Š**  
ğŸ“ **ç‰ˆæœ¬ï¼š2025-04-02**  

## **ğŸ“Œ 1. éœ€æ±‚åˆ†æ**  
- **ç”¨æˆ· (User)**
  - å¯ä»¥**åˆ›å»ºå¤šä¸ªæ´»åŠ¨**ï¼Œå³ä¸€ä¸ªç”¨æˆ·å¯èƒ½æ˜¯å¤šä¸ªæ´»åŠ¨çš„åˆ›å»ºè€…ã€‚
  - å¯ä»¥**å‚ä¸å¤šä¸ªæ´»åŠ¨**ï¼Œå³ç”¨æˆ·æ—¢å¯ä»¥æ˜¯è‡ªå·±æ´»åŠ¨çš„å‚ä¸è€…ï¼Œä¹Ÿå¯ä»¥åŠ å…¥åˆ«äººåˆ›å»ºçš„æ´»åŠ¨ã€‚  
  - **è‡ªå·±åˆ›å»ºçš„æ´»åŠ¨ï¼Œä¸€å®šå‚ä¸**ã€‚  

- **æ´»åŠ¨ (Activity)**
  - å¯ä»¥æœ‰**å¤šä¸ªç”¨æˆ·**å‚ä¸ï¼Œä¸”å…¶ä¸­**è‡³å°‘ä¸€ä¸ªæ˜¯åˆ›å»ºè€…**ã€‚  
  - **ç”¨æˆ·ä¹‹é—´æ˜¯æ­å­å…³ç³»**ï¼Œå³ç”¨æˆ·å’Œç”¨æˆ·ä¹‹é—´å› å…±åŒå‚ä¸æ´»åŠ¨è€Œå½¢æˆè¿æ¥ã€‚

---

## **ğŸ“Œ 2. æ•°æ®åº“è®¾è®¡**  
æ ¹æ®ä¸Šè¿°éœ€æ±‚ï¼Œç”¨æˆ·å’Œæ´»åŠ¨ä¹‹é—´å­˜åœ¨**å¤šå¯¹å¤šå…³ç³»**ï¼Œè¿™éœ€è¦ä¸€ä¸ª**ä¸­é—´è¡¨**æ¥å­˜å‚¨ç”¨æˆ·ä¸æ´»åŠ¨çš„å¯¹åº”å…³ç³»ã€‚  

### **âœ… ç”¨æˆ·è¡¨ (User)**  
| å­—æ®µå        | ç±»å‹              | è¯´æ˜ |
|--------------|-----------------|----|
| `id`        | `Integer (PK)`   | ç”¨æˆ· ID |
| `username`  | `String(50)`     | ç”¨æˆ·å |
| `email`     | `String(100)`    | é‚®ç®± |
| `password_hash` | `String(256)` | å“ˆå¸Œå¯†ç  |
| `created_at` | `DateTime`       | æ³¨å†Œæ—¶é—´ |
| **ğŸ”— å…³ç³»** | `activities (å¤šå¯¹å¤š)` | è¯¥ç”¨æˆ·å‚ä¸çš„æ‰€æœ‰æ´»åŠ¨ |

---

### **âœ… æ´»åŠ¨è¡¨ (Activity)**  
| å­—æ®µå        | ç±»å‹              | è¯´æ˜ |
|--------------|-----------------|----|
| `id`        | `Integer (PK)`   | æ´»åŠ¨ ID |
| `title`     | `String(255)`    | æ´»åŠ¨æ ‡é¢˜ |
| `description` | `Text`         | æ´»åŠ¨æè¿° |
| `created_at` | `DateTime`       | åˆ›å»ºæ—¶é—´ |
| **ğŸ”— å…³ç³»** | `participants (å¤šå¯¹å¤š)` | å‚ä¸æ­¤æ´»åŠ¨çš„æ‰€æœ‰ç”¨æˆ· |

---

### **âœ… ç”¨æˆ·-æ´»åŠ¨å…³ç³»è¡¨ (Participation)ï¼ˆä¸­é—´è¡¨ï¼‰**  
| å­—æ®µå         | ç±»å‹              | è¯´æ˜ |
|---------------|-----------------|----|
| `user_id`     | `Integer (FK â†’ users.id)` | ç”¨æˆ· ID |
| `activity_id` | `Integer (FK â†’ activities.id)` | æ´»åŠ¨ ID |
| `is_creator`  | `Boolean`        | æ˜¯å¦æ˜¯åˆ›å»ºè€… (True/False) |

---

## **ğŸ“Œ 3. Flask SQLAlchemy ä»£ç å®ç°**  
### **ç”¨æˆ·æ¨¡å‹ (User)**
```python
from datetime import datetime
from app import db
from werkzeug.security import generate_password_hash, check_password_hash

class User(db.Model):
    __tablename__ = 'users'

    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True, nullable=False)
    email = db.Column(db.String(100), unique=True, nullable=False)
    password_hash = db.Column(db.String(256), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

    # é€šè¿‡ä¸­é—´è¡¨ participation å…³è”æ´»åŠ¨
    activities = db.relationship('Activity', secondary='participation', back_populates='participants')

    def set_password(self, password):
        self.password_hash = generate_password_hash(password)

    def check_password(self, password):
        return check_password_hash(self.password_hash, password)

    def __repr__(self):
        return f'<User {self.username}>'
```

---

### **æ´»åŠ¨æ¨¡å‹ (Activity)**
```python
class Activity(db.Model):
    __tablename__ = 'activities'

    id = db.Column(db.Integer, primary_key=True)
    title = db.Column(db.String(255), nullable=False)
    description = db.Column(db.Text, nullable=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

    # é€šè¿‡ä¸­é—´è¡¨ participation å…³è”ç”¨æˆ·
    participants = db.relationship('User', secondary='participation', back_populates='activities')

    def __repr__(self):
        return f'<Activity {self.title}>'
```

---

### **ç”¨æˆ·-æ´»åŠ¨å…³ç³»æ¨¡å‹ (Participation)**
```python
class Participation(db.Model):
    __tablename__ = 'participation'

    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), primary_key=True)
    activity_id = db.Column(db.Integer, db.ForeignKey('activities.id'), primary_key=True)
    is_creator = db.Column(db.Boolean, default=False)  # æ˜¯å¦æ˜¯åˆ›å»ºè€…

    # å…³ç³»ï¼ˆä¸éœ€è¦é¢å¤–çš„ back_populatesï¼Œå› ä¸ºå·²ç»åœ¨ User å’Œ Activity é‡Œå®šä¹‰ï¼‰
    user = db.relationship(User, backref=db.backref("participation", cascade="all, delete-orphan"))
    activity = db.relationship(Activity, backref=db.backref("participation", cascade="all, delete-orphan"))

    def __repr__(self):
        return f'<Participation user_id={self.user_id} activity_id={self.activity_id} creator={self.is_creator}>'
```

---

## **ğŸ“Œ 4. å…³ç³»æ€»ç»“**
1. **ç”¨æˆ·ä¸æ´»åŠ¨æ˜¯å¤šå¯¹å¤šå…³ç³»**ï¼Œé€šè¿‡ `Participation` è¡¨ç®¡ç†ã€‚
2. **`is_creator=True` è¡¨ç¤ºç”¨æˆ·æ˜¯åˆ›å»ºè€…**ï¼Œå¦åˆ™åªæ˜¯å‚ä¸è€…ã€‚
3. **æ¯ä¸ªæ´»åŠ¨è‡³å°‘æœ‰ä¸€ä¸ªåˆ›å»ºè€…**ï¼Œä¸”åˆ›å»ºè€…ä¹Ÿä¼šè‡ªåŠ¨æˆä¸ºå‚ä¸è€…ã€‚

---

## **ğŸ“Œ 5. æ•°æ®æ“ä½œç¤ºä¾‹**
### **åˆ›å»ºæ´»åŠ¨**
```python
def create_activity(user_id, title, description):
    new_activity = Activity(title=title, description=description)
    db.session.add(new_activity)
    db.session.commit()

    # æ·»åŠ åˆ›å»ºè€…åˆ° participation
    participation = Participation(user_id=user_id, activity_id=new_activity.id, is_creator=True)
    db.session.add(participation)
    db.session.commit()
```

### **æ·»åŠ å‚ä¸è€…**
```python
def add_participant(user_id, activity_id):
    participation = Participation(user_id=user_id, activity_id=activity_id, is_creator=False)
    db.session.add(participation)
    db.session.commit()
```

### **è·å–æŸæ´»åŠ¨çš„æ‰€æœ‰å‚ä¸è€…**
```python
def get_activity_participants(activity_id):
    activity = Activity.query.get(activity_id)
    return [p.username for p in activity.participants]
```

### **è·å–æŸç”¨æˆ·çš„æ‰€æœ‰æ´»åŠ¨**
```python
def get_user_activities(user_id):
    user = User.query.get(user_id)
    return [(a.id, a.title) for a in user.activities]
```

---

## **ğŸ“Œ 6. æœªæ¥å¼€å‘æ–¹å‘**
âœ… **åŸºæœ¬åŠŸèƒ½**
- [x] ç”¨æˆ·æ³¨å†Œ/ç™»å½•  
- [x] åˆ›å»ºæ´»åŠ¨å¹¶è‡ªåŠ¨æˆä¸ºåˆ›å»ºè€…å’Œå‚ä¸è€…  
- [x] å‚ä¸æ´»åŠ¨  

ğŸš€ **æ‰©å±•åŠŸèƒ½**
- [ ] é€€å‡ºæ´»åŠ¨ï¼ˆä½†åˆ›å»ºè€…ä¸èƒ½é€€å‡ºï¼‰  
- [ ] ç”Ÿæˆâ€œæ­å­â€æ¨èï¼ŒåŸºäºç”¨æˆ·å…±åŒå‚ä¸çš„æ´»åŠ¨  
- [ ] æ´»åŠ¨çŠ¶æ€ç®¡ç†ï¼ˆå¦‚æ´»åŠ¨æ»¡å‘˜ã€æ´»åŠ¨ç»“æŸï¼‰  

---

## **ğŸ“Œ 7. ç»“è®º**
ä½ ç°åœ¨çš„æ•°æ®åº“è®¾è®¡å·²ç»æ¸…æ™°ï¼š
1. **ç”¨æˆ·-æ´»åŠ¨æ˜¯å¤šå¯¹å¤š**ï¼Œé€šè¿‡ `Participation` è¡¨ç®¡ç†ã€‚
2. **åˆ›å»ºè€…ä¹Ÿæ˜¯æ´»åŠ¨å‚ä¸è€…**ã€‚
3. **å…³ç³»è®¾è®¡åˆç†ï¼ŒæŸ¥è¯¢é«˜æ•ˆ**ã€‚

è¿˜è¦ætagsçš„æ˜¾ç¤º


# Flask åˆå§‹åŒ–æ•°æ®è¡¨å¹¶ç”Ÿæˆ Migration æ–‡ä»¶å¤¹

## 3. åˆå§‹åŒ– Migration æ–‡ä»¶å¤¹

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
flask db init
```

è¿™ä¼šåˆ›å»ºä¸€ä¸ª `migrations` æ–‡ä»¶å¤¹ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
migrations/
    versions/  # å­˜æ”¾å…·ä½“çš„è¿ç§»è„šæœ¬
    env.py    # è¿ç§»ç¯å¢ƒé…ç½®
    script.py.mako  # è¿ç§»è„šæœ¬æ¨¡æ¿
    README
```

## 4. åˆ›å»ºç¬¬ä¸€ä¸ªè¿ç§»

è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºåˆå§‹è¿ç§»ï¼š

```bash
flask db migrate -m "initial migration"
```

è¿™ä¼šæ‰«æä½ çš„æ¨¡å‹ä¸å½“å‰æ•°æ®åº“çŠ¶æ€ï¼ˆæ­¤æ—¶åº”è¯¥æ˜¯ç©ºæ•°æ®åº“ï¼‰çš„å·®å¼‚ï¼Œå¹¶åœ¨ `migrations/versions` ä¸­ç”Ÿæˆä¸€ä¸ªè¿ç§»è„šæœ¬ã€‚

## 5. åº”ç”¨è¿ç§»åˆ°æ•°æ®åº“

è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†è¿ç§»åº”ç”¨åˆ°æ•°æ®åº“ï¼š

```bash
flask db upgrade
```

è¿™ä¼šåˆ›å»ºæ‰€æœ‰å®šä¹‰çš„è¡¨ã€‚

## 6. åç»­å¼€å‘ä¸­çš„ä½¿ç”¨

å½“ä½ ä¿®æ”¹æ¨¡å‹åï¼Œé‡å¤ä»¥ä¸‹æ­¥éª¤ï¼š

```bash
flask db migrate -m "your migration message"
flask db upgrade
```

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿æ¥**ï¼šç¡®ä¿ `SQLALCHEMY_DATABASE_URI` é…ç½®æ­£ç¡®
2. **æ¨¡å‹å¯¼å…¥**ï¼šç¡®ä¿æ‰€æœ‰æ¨¡å‹åœ¨è¿è¡Œè¿ç§»å‘½ä»¤å‰å·²è¢«å¯¼å…¥
3. **Flask åº”ç”¨å·¥å‚æ¨¡å¼**ï¼šå¦‚æœä½¿ç”¨åº”ç”¨å·¥å‚æ¨¡å¼ï¼Œéœ€è¦è°ƒæ•´åˆå§‹åŒ–æ–¹å¼ï¼š

```python
# åœ¨å·¥å‚å‡½æ•°ä¸­
def create_app():
    app = Flask(__name__)
    # ...å…¶ä»–é…ç½®...
    db.init_app(app)
    migrate.init_app(app, db)
    return app
```

4. **å¤šæ•°æ®åº“æ”¯æŒ**ï¼šå¦‚æœéœ€è¦æ”¯æŒå¤šä¸ªæ•°æ®åº“ï¼Œéœ€è¦æ›´å¤æ‚çš„é…ç½®

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å°±å¯ä»¥åœ¨ Flask é¡¹ç›®ä¸­åˆå§‹åŒ–æ•°æ®åº“è¡¨å¹¶ç®¡ç†æ•°æ®åº“è¿ç§»äº†ã€‚
